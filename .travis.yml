language: minimal
services:
  - docker

branches:
  except:
  - "/^flux-*/"

env:
  global:
  - IMAGE_NAME="itsre/securitywiki"
  - COMMIT="${TRAVIS_COMMIT::8}"
  - secure: D4cKdI/hvQwXb6cj/plBOxjJvPHLTWgxTwBbCE9CsADoUpl2nq9//OJUmuIHb6MBOY/D5RWP2BwjWtlbkfpKDPTFEFU4m0juyi2KkhADnVFMWfF7h9aBvd2km+Erw1naq8drG7+dhIb/hBv32Y1AmbcGbkGBqIidRJGD5R5wnhKm4RABqzDb/ID3SglEcXMWqwBbkMqb4+b7btK3tbEMgm8Wjzfwf4xuvo//ulG+opG8RlR3Y1TiishvADVgVHfnYNFOifHphrriYJ4kluNXOumk/Tsi+9geNl6VBIR/s1XohmDauzvfE0l1Gh9oUm4eEnYC+aHxc8Qy9P26jxBH2YYovaBEi3Neppd4c1ShDhtwMnC3sPAakFAK7+e73/VT2Svq1dtE7aygfFbaOJz4jLcZJudQm9ayffeacMQbcfgzyrLLrGLdvTkkg1V7mwIMaJAhD4z5qu3VbpAlkRDWc7hAjRc1BKkhElfrfJ3ooeg9vkwaxj2ohfTLs6EpXsZaCNPq0gxwk2LxsSqaCO7qtdT7NN1pnwgMgE1oUZQ6EK2XGz9gHlwiDuzplVk5DMUmusXpEvv8W2Jj8UytqZzHSpGu8HisCsOY1a4EhukOTH/H4xLn3RrzmH7EnHvyNr0974X+ljOCYOZoaipyN5jeBaVT1so+D2qpsYl8OA+TsxE=
  - secure: pS6OiABsQ8bZzGPZkTRbPQGMNLBmO5Fi4WACwsQxq1Ck20ADAkx++zVGc00ukID1V7CzDn0HD06wJ37woyyfXt+U83e7i+JZO7+cAeMeh16QaUoE5ZYzm067SbP2r4g1tPsXvbof5TRaRQRX9pfqC8gYb80r+6cpfiuyCcMEx2mKGsAWinOblBUL7tq7bW39DiTWsyazXFRuiYjq3q+xwBmNSG0VjymDPYd2loXyfbDrMSlkLxhb4YtFhUdJPZcwbRmc8LuqV5inty2zKaTYulCMksvNOEdLQnWjWC9XlZ4PZlTeSvDBiZQtrshnKkZ1DSFAjnMP+ly4Z12LAblRbPsC06Y80LBV1zFzjvWT6fqiPN9tiZZKZvMs+RzqtBRkihSf2nqXwLqrOxS0ywm+cHgCzMOeIhOzo/A8hXAMeXDzliu7i9WZtI6h7A1v71qUr21QeaoJlO462QX4Bl+VDPBolW8k2JaMS/0GRc5cXNbfCJJlKRcrrc5RHF/9iTYhtOrbbhoTO3CdXiLTt4do5jYFWV/Vf8CSt3G4wwLAfeMTVqt0Ua94TEXCPHxPtExjw8twWkeHX7j8E+wwVxe++YzPcK5RIRVUj5k6Zq3sLt+3RuCxVEMesHUN0DLglrXtwehVcwjoWuBSmfwY2kOb8luus0PF8xhV/rL4MNOYTZY=

before_script:
  - SAFE_BRANCH_NAME=$(echo -n $TRAVIS_BRANCH | perl -pe's/[^a-zA-Z0-9_.-]/_/g' )
  - REVISION_TAG="$SAFE_BRANCH_NAME-$TRAVIS_COMMIT"
  - if [ "$TRAVIS_TAG" == "" ]; then SYMBOLIC_TAG="$SAFE_BRANCH_NAME-latest"; else SYMBOLIC_TAG="$TRAVIS_TAG"; fi
  - echo "Branch $SAFE_BRANCH_NAME"
  - echo "Tag $TRAVIS_TAG"
  - if [ "$TRAVIS_TAG" == "" ]; then docker pull "$IMAGE_NAME:$SYMBOLIC_TAG" || true; fi

after_script:
  - docker images

script:
  - docker build --tag "$IMAGE_NAME" --tag "$IMAGE_NAME:$COMMIT" .

before_deploy:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker tag $IMAGE_NAME "$IMAGE_NAME:$REVISION_TAG"
  - docker tag $IMAGE_NAME "$IMAGE_NAME:$SYMBOLIC_TAG"

deploy:
  provider: script
  on:
    all_branches: true
    condition: $TRAVIS_TAG != "" || $TRAVIS_BRANCH =~ ^(master|prod)$
  script:
    - docker push "$IMAGE_NAME:$REVISION_TAG" && docker push "$IMAGE_NAME:$SYMBOLIC_TAG"
