language: minimal
services:
  - docker

branches:
  except:
  - "/^flux-*/"

env:
  global:
    - IMAGE_NAME="itsre/securitywiki"
    - COMMIT="${TRAVIS_COMMIT::8}"
    - secure: "ZfeDjBHtXcDpjFWgytZ1CaJ+AlrM/rFwXL9CHbrgcJW4MVT3Vv8QD9hMJjchWwhlNhkNYm0fPtorud8ZQz5uWCYP17kUGgIbcwNVcBInCNCz0K+KmWVU/0M9qCF6LE6u8lQ1WYasVHXNl18Gp020ajxxQSvy8TqfFbQj+m8p0tBXILal4N1X9BXDt0OvrFtu4mT6uzslhCgWHfAJxFL4kRWmVaayYJHwbSUA4WnaFd0S+VJeIgvp5H/0rP2qpsT5UVQUzAnbmYGeBMvKfvZCpfQVfekQiHMIlTcHQ7Wg+3VA3AZzUXRW9x4ALOKIL9erUUC9SUMZGdIY6vNJJEYx1fYgtRUEEitNqJkd4gxLPIsv9UWFnGcPWw7tlg+VLWVE402n6AEEcFfqpRp2NKFxUPFaTWJB7CeUyxoDnud3bbfaPhq/xl9D7qjbfxAqSF/UXv+cZpJ0wCeBUTlSDQtwhKpSJHtb9Ik6p/xLt3tYQ9Qt7vFby3dw0hRI1JGQXencH5kYoKjH/2LsG4hLP/sSdu00DWdUmjyFhJZiu1CH9mWkO+8F3f6fcO10wuTFljGJrMavE0wbA62LOTbWd4dWW/7fRjyqekufy3T6MvQsM+dkMMyep8umt1mQBHx+Qpb+Vr8Uz/fhKPRfE6+q2A48wuJPSFrv3J0H6IrQ0H0BYqo="
    - secure: "OWnxiGaIHov/dUkIDD5kF2ZbCPdzU6E2+H86Ck3zf32kHNaS3OOZ9o3vGYds4J+0qdRqbIaD1So0CULX/dRA8Er74vCfbdHUy3vRr92rRHl3xgjrKNPagLu0tkjEtcFxoudcP4IQqsWy70grRzbOvi0LPRSAq4q8NTJPvaTpolr6FB7pRWfszxTnIFJA+8i9SCRNvUshM/toKzC1Pcr/t8tAgtnkq2aosVgRvFwe/go5ZuY2UJ6b+yDGn+e+iT8oZzLyxqG+kWnxyVJSooMIXs7v1d8XiW+Hy1Dd46tSt0V/BTMYOpCBWWDTe2SJqvYXH0zvF99B9wE/gbftQk7rUF59Fu0Zdjpje8LIOISnSaQoXfrWSZZ8q19jVJ786tHhGuV+liW/iUn88tC4Oq7+CjuWxLqCIvENyZCBGghDr9Sa0JFvRlJUy5co9G7SiH8e8iMvOrW4ShZhLEdx0NhyDsgNjwWT1ZI+UzDSmc6/0Kj53nQtPcbWfoeSLJrU4VCEBnyTS5g/EXXR17jykxTPOGvrz95T6EqcMxW5uF4c9mven7CAVe3rDZ2HlQJbaaK92qIHahq8DFWY4xCuyr2VhqEMgjQLmcTzlTLG+5WEmrUEtynLZOmyuQw5Z52kq9fkVnnMWf+Y10m7tWmsfwwEOuvh9MQM3icoi6rv6m1jGZ4="

before_script:
  - SAFE_BRANCH_NAME=$(echo -n $TRAVIS_BRANCH | perl -pe's/[^a-zA-Z0-9_.-]/_/g' )
  - REVISION_TAG="$SAFE_BRANCH_NAME-$TRAVIS_COMMIT"
  - if [ "$TRAVIS_TAG" == "" ]; then SYMBOLIC_TAG="$SAFE_BRANCH_NAME-latest"; else SYMBOLIC_TAG="$TRAVIS_TAG"; fi
  - echo "Branch $SAFE_BRANCH_NAME"
  - echo "Tag $TRAVIS_TAG"
  - if [ "$TRAVIS_TAG" == "" ]; then docker pull "$IMAGE_NAME:$SYMBOLIC_TAG" || true; fi

after_script:
  - docker images

script:
  - docker build --tag "$IMAGE_NAME" --tag "$IMAGE_NAME:$COMMIT" .

before_deploy:
  - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
  - docker tag $IMAGE_NAME "$IMAGE_NAME:$REVISION_TAG"
  - docker tag $IMAGE_NAME "$IMAGE_NAME:$SYMBOLIC_TAG"

deploy:
  provider: script
  on:
    all_branches: true
    condition: $TRAVIS_TAG != "" || $TRAVIS_BRANCH =~ ^(master|prod)$
  script:
    - docker push "$IMAGE_NAME:$REVISION_TAG" && docker push "$IMAGE_NAME:$SYMBOLIC_TAG"
